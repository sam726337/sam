{% extends "base.html" %}

{% block title %}Schedule - EduStream{% endblock %}

{% block content %}
<div class="schedule-page">
    <div class="page-header">
        <h1>Class Schedule</h1>
        <p>{% if session.role == 'teacher' %}Manage your teaching schedule{% else %}View your class timetable{% endif %}</p>
    </div>

    <div class="schedule-container">
        <!-- Calendar View -->
        <div class="calendar-section">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="currentMonth"></h2>
                <button class="calendar-nav" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated by JavaScript -->
            </div>
        </div>

        <!-- Classes List -->
        <div class="classes-schedule">
            <h3>Upcoming Classes</h3>
            {% if classes %}
            <div class="schedule-list">
                {% for class in classes %}
                <div class="schedule-item {% if class.is_live %}live{% endif %} {% if class.status == 'completed' %}completed{% endif %}">
                    <div class="schedule-time">
                        <div class="time">{{ class.scheduled_time.strftime('%H:%M') }}</div>
                        <div class="date">{{ class.scheduled_time.strftime('%b %d') }}</div>
                    </div>
                    <div class="schedule-content">
                        <h4>{{ class.title }}</h4>
                        <p>{{ class.description }}</p>
                        <div class="schedule-meta">
                            {% if session.role == 'student' %}
                            <span><i class="fas fa-user-tie"></i> {{ class.teacher.username }}</span>
                            {% endif %}
                            <span><i class="fas fa-clock"></i> {{ class.duration_minutes }} min</span>
                            <span class="status-badge {{ class.status }}">
                                {% if class.status == 'live' %}
                                    <i class="fas fa-circle"></i> Live
                                {% elif class.status == 'scheduled' %}
                                    <i class="fas fa-clock"></i> Scheduled
                                {% else %}
                                    <i class="fas fa-check"></i> Completed
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="schedule-actions">
                        {% if class.status == 'live' %}
                            <a href="{{ url_for('live_class', class_id=class.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-video"></i> Join
                            </a>
                        {% elif class.status == 'scheduled' and session.role == 'teacher' %}
                            <a href="{{ url_for('start_class', class_id=class.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-play"></i> Start
                            </a>
                        {% endif %}
                        <a href="{{ url_for('materials', class_id=class.id) }}" class="btn btn-outline btn-sm">
                            <i class="fas fa-folder"></i> Materials
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-alt"></i>
                <h3>No Classes Scheduled</h3>
                <p>{% if session.role == 'teacher' %}Create your first class to get started{% else %}Enroll in classes to see your schedule{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
const classes = {{ classes|map(attribute='scheduled_time')|map('string')|list|tojson }};

function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });
    
    // Add calendar days
    const currentDate = new Date(startDate);
    for (let i = 0; i < 42; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        if (currentDate.getMonth() !== month) {
            dayElement.classList.add('other-month');
        }
        
        // Check if this day has classes
        const dayString = currentDate.toISOString().split('T')[0];
        const hasClasses = classes.some(classDate => 
            classDate.startsWith(dayString)
        );
        
        if (hasClasses) {
            dayElement.classList.add('has-events');
        }
        
        dayElement.innerHTML = `
            <span class="day-number">${currentDate.getDate()}</span>
            ${hasClasses ? '<div class="event-indicator"></div>' : ''}
        `;
        
        calendarGrid.appendChild(dayElement);
        currentDate.setDate(currentDate.getDate() + 1);
    }
}

function updateCalendarHeader() {
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendarHeader();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendarHeader();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    updateCalendarHeader();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
});
</script>
{% endblock %}
