{% extends "base.html" %}

{% block title %}Materials: {{ class_obj.title }} - EduStream{% endblock %}

{% block content %}
<div class="materials-page">
    <div class="page-header">
        <div class="header-info">
            <h1>{{ class_obj.title }} - Materials</h1>
            <p>{{ class_obj.description }}</p>
        </div>
        {% if session.role == 'teacher' and class_obj.teacher_id == session.user_id %}
        <button class="btn btn-primary" onclick="showUploadModal()">
            <i class="fas fa-upload"></i> Upload Material
        </button>
        {% endif %}
    </div>

    {% if materials %}
    <div class="materials-grid">
        {% for material in materials %}
        <div class="material-card">
            <div class="material-header">
                <div class="material-icon-large">
                    {% if material.file_type in ['pdf'] %}
                        <i class="fas fa-file-pdf"></i>
                    {% elif material.file_type in ['doc', 'docx'] %}
                        <i class="fas fa-file-word"></i>
                    {% elif material.file_type in ['ppt', 'pptx'] %}
                        <i class="fas fa-file-powerpoint"></i>
                    {% elif material.file_type in ['mp4', 'avi', 'mov'] %}
                        <i class="fas fa-file-video"></i>
                    {% elif material.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}
                        <i class="fas fa-file-image"></i>
                    {% else %}
                        <i class="fas fa-file"></i>
                    {% endif %}
                </div>
                <div class="material-type">{{ material.file_type.upper() }}</div>
            </div>
            <div class="material-content">
                <h3>{{ material.title }}</h3>
                <p>{{ material.description or 'No description provided' }}</p>
                <div class="material-meta">
                    <span><i class="fas fa-calendar"></i> {{ material.uploaded_at.strftime('%Y-%m-%d') }}</span>
                    <span><i class="fas fa-file"></i> {{ material.filename.split('_', 2)[-1] if '_' in material.filename else material.filename }}</span>
                </div>
            </div>
            <div class="material-actions">
                <a href="{{ url_for('download_file', filename=material.filename) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Download
                </a>
                {% if material.file_type in ['mp4', 'avi', 'mov'] %}
                <button class="btn btn-outline btn-sm" onclick="previewVideo('{{ material.filename }}', '{{ material.title }}')">
                    <i class="fas fa-play"></i> Preview
                </button>
                {% elif material.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}
                <button class="btn btn-outline btn-sm" onclick="previewImage('{{ material.filename }}', '{{ material.title }}')">
                    <i class="fas fa-eye"></i> Preview
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <h3>No Materials Available</h3>
        <p>{% if session.role == 'teacher' %}Upload your first teaching material to get started{% else %}Check back later for course materials{% endif %}</p>
        {% if session.role == 'teacher' and class_obj.teacher_id == session.user_id %}
        <button class="btn btn-primary" onclick="showUploadModal()">
            <i class="fas fa-upload"></i> Upload Your First Material
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Upload Modal -->
{% if session.role == 'teacher' and class_obj.teacher_id == session.user_id %}
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Teaching Material</h3>
            <button class="modal-close" onclick="hideUploadModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('upload_material', class_id=class_obj.id) }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Material Title</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="file">Select File</label>
                <div class="file-upload">
                    <input type="file" id="file" name="file" required accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif,.mp4,.avi,.mov">
                    <div class="file-upload-display">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Choose file or drag and drop</span>
                    </div>
                </div>
                <small>Supported formats: PDF, DOC, PPT, Images, Videos (Max: 16MB)</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="hideUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload Material</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="previewTitle">Preview</h3>
            <button class="modal-close" onclick="hidePreviewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="previewContent"></div>
        </div>
    </div>
</div>

<script>
function showUploadModal() {
    document.getElementById('uploadModal').style.display = 'flex';
}

function hideUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

function showPreviewModal() {
    document.getElementById('previewModal').style.display = 'flex';
}

function hidePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

function previewVideo(filename, title) {
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewContent').innerHTML = `
        <video controls style="width: 100%; max-height: 500px;">
            <source src="{{ url_for('download_file', filename='') }}${filename}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    `;
    showPreviewModal();
}

function previewImage(filename, title) {
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewContent').innerHTML = `
        <img src="{{ url_for('download_file', filename='') }}${filename}" 
             alt="${title}" 
             style="width: 100%; max-height: 500px; object-fit: contain;">
    `;
    showPreviewModal();
}

// File upload display
document.getElementById('file')?.addEventListener('change', function(e) {
    const display = document.querySelector('.file-upload-display span');
    if (e.target.files.length > 0) {
        display.textContent = e.target.files[0].name;
    } else {
        display.textContent = 'Choose file or drag and drop';
    }
});
</script>
{% endblock %}
